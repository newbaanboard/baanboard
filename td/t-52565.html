<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="keywords" content="bshell received SIGTERM, baan,baanerp,erp,forum,discussion,bulletin board" />
	<meta name="description" content="[Archive] bshell received SIGTERM Tools Development" />
	
	<title>bshell received SIGTERM [Archive]  - Baanboard.com</title>
	<link rel="stylesheet" type="text/css" href="../styles.css" />
</head>
<body>
<div class="pagebody">
<div id="navbar"><a href="../index.html">Newbaanboard</a> &gt; <a href="../index.html">Baan Quick Support: Functional &amp; Technical</a> &gt; <a href="../index.html">Tools Development</a> &gt; bshell received SIGTERM</div>
<hr />
<div class="pda"></div>

<hr />

<div class="post"><div class="posttop"><div class="username">manojsharma</div><div class="date">30th May 2008, 19:08</div></div><div class="posttext">Hi,<br />
<br />
sometimes, when I run a session manually or through Job, it get hang. On viewing the bshell log, I found the error &quot;log msg : bshell received SIGTERM&quot;<br />
<br />
Can anybody help me, what is this problem and how to solve this.<br />
<br />
Thanks in advance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">shah_bs</div><div class="date">30th May 2008, 19:51</div></div><div class="posttext">Well, the SIGTERM message is logged AFTER you have quit out of the session BECAUSE you forcefully quit the session. The hanging is because of some other reasons. The only way I know is to run the session under debug to see where it seems to slow down.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">NPRao</div><div class="date">30th May 2008, 20:13</div></div><div class="posttext">If you are on UNIX look for man kill<br />
<br />
 signum   signame   Name            Description  <br />
___________________________________________________________________________<br />
      0     SIGNULL   Null            Check access to pid<br />
      1     SIGHUP    Hangup          Terminate; can be trapped<br />
      2     SIGINT    Interrupt       Terminate; can be trapped<br />
      3     SIGQUIT   Quit            Terminate with core dump; can be trapped<br />
      9     SIGKILL   Kill            Forced termination; cannot be trapped<br />
     15     SIGTERM   Terminate       Terminate; can be trapped<br />
     24     SIGSTOP   Stop            Pause the process; cannot be trapped<br />
     25     SIGTSTP   Terminal stop   Pause the process; can be trapped<br />
     26     SIGCONT   Continue        Run a stopped process<br />
 SIGTERM (15), the (default) terminate signal, can be trapped by the<br />
      receiving process, allowing the receiver to execute an orderly<br />
      shutdown or to ignore the signal entirely.  For orderly operations,<br />
      this is the perferred choice.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">loveneesh</div><div class="date">30th May 2008, 20:53</div></div><div class="posttext">When I run the session in debug mode, it work fine. Actually, its a processing session which read files from a specified path on server, process the file and update baan table and session complete in 10-12 minutes.<br />
<br />
I am running the session through Job after every one hour but sometimes, it get hang and the error &quot;log msg : bshell received SIGTERM&quot; reported in log.bshell and sometime &quot;errno 0 bdb_errno213 (Transaction is started but not updated) log msg : bshell received SIGTERM .<br />
<br />
Thanks in advance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">loveneesh</div><div class="date">31st May 2008, 10:02</div></div><div class="posttext">Thanks NPR,<br />
<br />
I am on HP Unix, Oracle, Baan IV c4, but how to solve this problem</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mark_h</div><div class="date">2nd June 2008, 15:34</div></div><div class="posttext">When I run the session in debug mode, it work fine. Actually, its a processing session which read files from a specified path on server, process the file and update baan table and session complete in 10-12 minutes.<br />
<br />
I am running the session through Job after every one hour but sometimes, it get hang and the error &quot;log msg : bshell received SIGTERM&quot; reported in log.bshell and sometime &quot;errno 0 bdb_errno213 (Transaction is started but not updated) log msg : bshell received SIGTERM .<br />
<br />
Thanks in advance<br />
<br />
It sounds to me like something is causing it to abort while processing - causing the transaction is started, but not updated message.  Are you killing the job when it hangs?  That would cause these messages.  Have you checked the data it is processing in the file? Looking for things like control characters or escape sequences?</div></div><hr />


<div class="post"><div class="posttop"><div class="username">loveneesh</div><div class="date">3rd June 2008, 07:53</div></div><div class="posttext">I found in log.cleandefunct that after every 10 min it killing ideal session but my session is contineously running and my session takes around 12-14 min. I dont know why it is hanging or killing out.<br />
<br />
Actully, my session is scanning files from a particular folder on server and if the file is valid then it moves to another folder otherwise it delete file and then from the another folder it start processing the file.<br />
<br />
Thanks in advance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">mark_h</div><div class="date">3rd June 2008, 18:22</div></div><div class="posttext">Can you try changing how often that runs?  Maybe instead of 10 minutes how about every 15 minutes.  Just to see if that fixes the problem.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">NPRao</div><div class="date">3rd June 2008, 21:01</div></div><div class="posttext">loveneesh,<br />
<br />
Please post your code, it appears the bshell/session timeouts are terminating it.<br />
<br />
Also post the contents of $BSE/lib/bse_vars, $BSE/lib/defaults/all</div></div><hr />


<div class="post"><div class="posttop"><div class="username">loveneesh</div><div class="date">4th June 2008, 08:59</div></div><div class="posttext">Thanks NPR,<br />
<br />
Here is my code<br />
<br />
<br />
declaration:<br />
	#include &lt;bic_tt&gt;	<br />
	table	ttdwms610	|* ASN Header<br />
	table	ttdwms611	|* ASN Header - Details<br />
	table	ttdwms615	|* ASN Lines<br />
	table	ttdwms616	|* ASN Lines - No. of Packages - Detail<br />
	table	ttdwms650	|* ASN Header - History<br />
	table	ttdwms651	|* ASN Header - Details - History<br />
	table	ttdwms655	|* ASN Lines - History...<br />
	table	ttdwms656	|* ASN Lines - No. of Packages - Detail - History<br />
	table	ttdwms600	|* ASN Receiving Parameter<br />
<br />
	table	ttdwms609	|* ASN Log table<br />
	table   ttdwms608<br />
	<br />
	#define RECORDLN 600<br />
	#define	RETLN	 1500<br />
	#define DIM1	 1400<br />
	#define	DIM2	 100000<br />
	#define PATHLEN	 250<br />
	<br />
	|Form Variable<br />
	extern	domain	tcmcs.str80	disp.messg<br />
	<br />
	<br />
	| THESE ARE THE VARIABLES DEFINED FOR DIFFRENT PATHS			<br />
			<br />
	| INITIAL PATHS DEFINED FOR THE FILES<br />
		string		path.input.o(PATHLEN) 				| INPUT FILE<br />
		string		path.proc.o(PATHLEN)  				| PROCESSED FILE<br />
		string		path.log.o(PATHLEN)   				| LOG FILE<br />
		| ACTUAL PATHS TO OPEN THE FILES					<br />
		string		path.log.tmp(PATHLEN)				| LOG FILE FOR TMP FILE<br />
		string		path.input(PATHLEN)	    			| INPUT FILE<br />
		string		path.proc(PATHLEN)	     			| PROCESSED FILE<br />
		string		bckp.path(PATHLEN)	     			| PROCESSED FILE for backup directory<br />
		string		ls.path.name(PATHLEN)	  			| LIST COMMAND   <br />
		string		mv.path.name(PATHLEN)   			| MOVE COMMAND<br />
		string		cv.path.name(PATHLEN)   			| MOVE COMMAND			<br />
		string		path.move.o(PATHLEN)				| PATH FROM ASN MOVE	| POLCUS1O.n	<br />
		string		path.move(PATHLEN)	    			| FILE TO BE MOVED FROM | POLCUS10.n<br />
	|FILE NAMES			<br />
		string		file.name(PATHLEN)				|FILE NAME VARIABLE<br />
	<br />
	|VARIABLES FOR DIFFRENT FILE POINTERS<br />
		long		retval,fp,rec.ctr,i, file.ctr, j,file.val ,fp.tmp,fp.log.tmp<br />
<br />
	<br />
	|VARIABLE FOR STORING THE RECORD OF THE FILE<br />
		string		retline(RETLN),file.line(RETLN),current.record(RETLN)<br />
	<br />
	| ARRAY VARIABLE FOR STORING ALL THE DATA OF THE FILE			<br />
		string  	str_arr(DIM1,DIM2),file_arr(DIM1,DIM2)<br />
	<br />
	|OTHER REQUIRED VARIABLE<br />
	string 			str_date(12)				| STORE TODAY'S DATE<br />
	domain	tcyesno		file.blank				| CHECK FOR BLANK FILE<br />
	domain	tcncmp		home.company				| EXTRACT THE HOME COMPAY IN THIS<br />
		long 		dd,yy,mm 				| TEMPORARY VARIABLES FOR DATE/YEAR/MONTH<br />
		long 		ret					| RETURN VALUE FOR COMMANDS<br />
	<br />
	| THESE ARE THE VARIABLES DEFINED FOR THE ERROR<br />
<br />
	domain 	tcyesno		err.hap<br />
	domain	tcmcs.str80	error.code, x.error.code<br />
	<br />
	|VARIABLES FOR APPL. LOCK<br />
	domain	tcmcs.str20	lockedkey<br />
	domain  tcmcs.str12	lockedby<br />
		long		ret.key		<br />
		<br />
	domain	tctime		curr.time<br />
	domain	tcdate		curr.date<br />
			<br />
<br />
<br />
	|VARIABLES FOR THE RETRIEVING DATA FROM THE FILE<br />
		|Leader Fields - Position 1 to 55 of each record<br />
| 		string		file.duns.number(9),		|DUNS Number<br />
		string		file.plant.code(3),		|Plant Code<br />
				file.supplier(12),		|Supplier Code<br />
				file.trans.date(6),		|Transaction Date (YYMMDD)<br />
				file.trans.time(4),		|Transaction Time (HHMM)<br />
				file.ship.id(15),		|Shipment ID(ASN Number)<br />
| 				file.ship.item.no(4),		|Shipment Item Number<br />
| 				file.edi.std.indicator(1),	|EDI Standard Indicator<br />
				file.rec.type(1)		|File Record Type<br />
				<br />
		|Data Fields - Record Type 0 - Header<br />
| 		string		file.ship.from(35),		|Ship Form Name	<br />
		string		file.pack.list.0(15),		|Packing List Number - Record type 0 Zero<br />
				file.bill.lading.no(15),	|Bill of Lading Number<br />
				file.carrier.ref.no(15),	|Carrier Reference Number<br />
				file.freight.bill.no(30),	|Freight Bill Number<br />
| 				file.ship.century(2),		|Ship Date Century<br />
				file.ship.date(6),		|Ship Date	<br />
				file.ship.time(4),		|Ship Time<br />
| 				file.arrival.century(2),	|Arrival Date Century<br />
				file.arrival.date(6),		|Arrival Date	<br />
				file.arrival.time(4),		|Arrival Time<br />
				file.no.container(7),		|No. of Containers<br />
| 				file.no.container.sign(1),	|No. of Containers Sign<br />
				file.wght.shipment(11),		|Gross Weight of Shipment<br />
| 				file.wght.shipment.sign(1),	|Gross Weight of Shipment Sign<br />
				file.wght.uom(2),		|Weight Unit of Measure<br />
| 				file.board.code(2),		|Free on Board code<br />
				file.scac.code(17),		|SCAC Code<br />
| 				file.ship.equp.type(2),		|Shipment Equipment Type<br />
| 				file.ship.equp.id1(4),		|Shipment Equipment ID 1<br />
| 				file.ship.equp.id2(10),		|Shipment Equipment ID 2		<br />
| 				file.spec.hand.code(3),		|Special Handling code<br />
| 				file.hzd.mat.qual(1),		|Hazardous Material Qualifier<br />
| 				file.hzd.mat.code(4),		|Hazardous Material Code<br />
				file.purpose.code(2),		|Purpose Code<br />
| 				file.pack.list.header(1),	|Packing List In Header<br />
				file.seq.no(15)			|File Sequence No<br />
| 				file.filler.0(28)		|Filler - Record type 0(Zero)<br />
				<br />
		|Data Fields - Record Type 1 - Header		<br />
| 		string		file.ship.to.name(35),		|Ship To Name<br />
		string		file.ship.to.code(10)		|Ship To Code<br />
| 				file.ship.to.add1(30),		|Ship-to address line 1<br />
| 				file.ship.to.add2(30),		|Ship-to address line 2<br />
| 				file.ship.to.add3(30),		|Ship-to address line 3<br />
| 				file.ship.to.add4(30),		|Ship-to address line 4<br />
| 				file.ship.to.add5(30),		|Ship-to address line 5<br />
| 				file.ship.to.add6(30)		|Ship-to address line 6<br />
| 				file.filler.1(20)		|Filler - Record type 1(One)<br />
				<br />
		|Data Fields - Record Type 2 - Detail<br />
| 		string		file.po(25),			|PO Number<br />
| 				file.release.no(3),		|Release Number<br />
		string		file.item(30),			|Part Number<br />
				file.vendor.item(30),		|Vendor Part Number<br />
				file.revision(2),		|Revision Number<br />
				file.pack.list.2(15),		|Packing List Number - Record type 2 Two<br />
				file.unit.ship(11),		|Units shipped<br />
| 				file.unit.ship.sign(1),		|Units shipped Sign<br />
				file.uom(2)			|Unit of Measure<br />
| 				file.item.stat(2),		|PO item status<br />
| 				file.vendor.code2(12),		|Vendor code 2<br />
| 				file.call.off(12),		|Call-off reference number<br />
| 				file.del.loca(15),		|Delivery location<br />
| 				file.po.line(5)			|PO Line Item Number<br />
| 				file.filler.2(80)		|Filler - Record type 2(Two)<br />
				<br />
		|Data Fields - Record Type 3 - Detail<br />
| 		string		file.cont.type(5),		|Type of container<br />
| 		string		file.unit.cont(11),		|Units per container<br />
| 		string		file.unit.cont.sign(1),		|Units per container sign<br />
| 				file.cont.size(5)		|Container size<br />
| 				file.total.cont(5)		|Total No of Containers<br />
| 				file.filler.3(218)		|Filler - Record type 3(Three)<br />
				<br />
		|Data Fields - Record Type 4 - Detail		<br />
| 		string		file.total.lines(4),		|Count of Detail Lines		<br />
| 		string		file.filler.4(241)		|Filler - Record type 4(Four)<br />
				<br />
	|*********************** variables for table insertion/ Baan Comparison **************<br />
	<br />
	domain	tcmcs.str3	plant.code<br />
	domain	tcmcs.str15	asn.no<br />
	domain	tcsuno		supplier<br />
	domain	tcorno		rec.type<br />
	domain	tcorno		seq.no<br />
	domain	tcdate		trans.date<br />
	domain	tctime		trans.time<br />
	domain	tcdate		ship.date<br />
	domain	tcdate		arrival.date<br />
	domain	tctime		ship.time<br />
	domain	tctime		arrival.time<br />
	domain	tcmcs.str15	packing.list.no,<br />
				bill.lading.no,	<br />
				carrier.ref.no<br />
	domain	tcmcs.str30	freight.bill.no<br />
	domain	tcwght		wght.shipment<br />
	domain	tccuni		wght.uom<br />
	domain	tdwms.purpose	purpose.code<br />
	domain	tdwms.cont	no.container<br />
	domain	tcmcs.str35	ship.to.name<br />
	domain	tcmcs.str10	ship.to.code<br />
	domain	tcitem		item	<br />
	domain	tdpsc.cpno	vendor.item<br />
	domain	tcmcs.str2	revision<br />
	domain	tcmcs.str15	pack.list.2<br />
	domain	tcqiv1		unit.ship<br />
	domain	tccuni		uom<br />
	domain	tcdate		temp.date<br />
	<br />
	domain	tcncmp		company<br />
	<br />
	domain	tcorno		m.seqn<br />
	domain  tcmcs.str17	scac.code<br />
	domain  tcbool		file.load<br />
	domain  tcorno		m.srno<br />
	<br />
	domain  tcmcs.str9	table.name<br />
	long	table.eror<br />
	domain  tcbool		error.found<br />
	domain	tcsuno		m.suno			| POLCUS10.n<br />
<br />
before.program:<br />
	if not initialization() then<br />
		exit()<br />
	endif	<br />
	lockedkey = &quot;tdwms6210m002&quot;<br />
	ret.key = appl.get.user(lockedkey,lockedby)<br />
| 	ret.key = appl.set(lockedkey,APPL.EXCL)<br />
 	if ret.key = 0 then<br />
| 		appl.get.user(lockedkey,lockedby)<br />
		mess(&quot;tdwms26210.01&quot;,1,lockedby)<br />
		|* %s User is using this session.....<br />
		end()<br />
 	endif	<br />
|****************************** form section **********************************<br />
<br />
form.1:<br />
init.form:<br />
	get.screen.defaults()<br />
<br />
|****************************** choice section ********************************<br />
<br />
choice.cont.process:<br />
on.choice:<br />
	lockedkey = &quot;tdwms6210m002&quot;<br />
	ret.key = appl.set(lockedkey,APPL.EXCL)<br />
	if ret.key &lt;&gt; 0 then<br />
		appl.get.user(lockedkey,lockedby)<br />
		mess(&quot;tdwms26210.01&quot;,1,lockedby)<br />
		|* %s User is using this session.....<br />
		end()<br />
	endif	<br />
	<br />
	curr.date = date.num()<br />
	curr.time = tcqms.dll0001.num.to.time(time.num())<br />
	<br />
	move.valid.files()		| POLCUS10.n<br />
	read.main.table()<br />
	<br />
<br />
	select tdwms608.*<br />
	from   tdwms608 for update<br />
	where  tdwms608._index1 = {:curr.date,:curr.time}<br />
	selectdo<br />
		tdwms608.endt = date.num()<br />
		tdwms608.entm = tcqms.dll0001.num.to.time(time.num())<br />
		db.update(ttdwms608,db.retry)<br />
		commit.transaction()<br />
	selectempty<br />
		tdwms608.srno = 1<br />
		tdwms608.endt = date.num()<br />
		tdwms608.entm = tcqms.dll0001.num.to.time(time.num())<br />
		db.insert(ttdwms608,db.retry)<br />
		commit.transaction()		<br />
	endselect		<br />
	<br />
	display.form.message(form.text$(&quot;tdwms26210.16&quot;))<br />
	|* Process Complete.<br />
	ret.key = appl.delete(lockedkey)<br />
|****************************** function section ******************************<br />
<br />
functions:<br />
function domain tcbool initialization()<br />
{	<br />
	company = get.compnr()<br />
<br />
	select	tdwms600.ncmp<br />
	from	tdwms600<br />
	where	tdwms600._index1 = {:company}<br />
	selectdo<br />
	selectempty	<br />
		mess(&quot;tdwms26102.02&quot;,1)<br />
		|* Parameters not Defined...<br />
		return(false)<br />
	endselect<br />
	<br />
	select	tdwms601.code<br />
	from	tdwms601<br />
	as set with 1 rows<br />
	selectdo<br />
	selectempty<br />
		mess(&quot;tdwms26102.03&quot;,1)<br />
		|* Validation Codes not Defined....<br />
		return(false)	<br />
	endselect	<br />
	return(true)<br />
}<br />
<br />
function move.valid.files()					| POLCUS10.sn<br />
{<br />
	db.retry.point()		<br />
	<br />
	<br />
	select tdwms608.*<br />
	from   tdwms608 for update<br />
	where  tdwms608._index1 = {:curr.date,:curr.time}<br />
	selectdo<br />
| 		tdwms608.stdt = date.num()<br />
| 		tdwms608.sttm = tcqms.dll0001.num.to.time(time.num())<br />
| 		tdwms608.endt = 0<br />
| 		tdwms608.entm = 0<br />
| 		db.update(ttdwms608,db.retry)<br />
| 		commit.transaction()<br />
	selectempty<br />
		tdwms608.srno = 1<br />
		tdwms608.stdt = curr.date<br />
		tdwms608.sttm = curr.time<br />
		tdwms608.endt = 0<br />
		tdwms608.entm = 0<br />
	<br />
		db.insert(ttdwms608,db.retry)<br />
		commit.transaction()		<br />
	endselect	<br />
	<br />
	initailize.variables.level1()			<br />
	<br />
	| PROCEDURE 1 STARTS <br />
		| EXTRACT DIR INFO FROM CSCN PARAMETERS AND CREATE LOG FILE. <br />
		| IF LOG FILE IS NOT CREATED THEN END THE PROGRAM AFTER MESSAGE<br />
	initial_actions()<br />
	if err.hap = tcyesno.yes then<br />
		err.hap = tcyesno.no<br />
		end()<br />
	endif<br />
	| PROCEDURE 1 END<br />
	<br />
	| PROCEDURE 2 STARTS <br />
	| GET THE FILE NAMES IN THE DIRECTORIES AND STORE IT IN AN FILE.<br />
	| GIVE ERROR IF THERE IS SOME PROBLEM<br />
<br />
	get.filenames.new()<br />
	if err.hap = tcyesno.yes then<br />
		err.hap = tcyesno.no<br />
		seq.close(fp.log.tmp)<br />
| 		end()					| POLCUS10.n<br />
	endif<br />
	display.form.message(sprintf$(form.text$(&quot;tdwms26210.14&quot;),file.ctr))<br />
	|* Total Number Of Files : %d<br />
	<br />
<br />
}								| POLCUS10.en<br />
<br />
function read.main.table()<br />
{<br />
	db.retry.point()		|LK.N			<br />
| 	curr.date = date.num()					| POLCUS10.so<br />
| 	curr.time = tcqms.dll0001.num.to.time(time.num())<br />
	initailize.variables.level1()			<br />
| 	<br />
| 	| PROCEDURE 1 STARTS <br />
| 		| EXTRACT DIR INFO FROM CSCN PARAMETERS AND CREATE LOG FILE. <br />
| 		| IF LOG FILE IS NOT CREATED THEN END THE PROGRAM AFTER MESSAGE<br />
| 	initial_actions()<br />
| 	if err.hap = tcyesno.yes then<br />
| 		err.hap = tcyesno.no<br />
| 		end()<br />
| 	endif<br />
| 	| PROCEDURE 1 END<br />
| 	<br />
| 	| PROCEDURE 2 STARTS <br />
| 	| GET THE FILE NAMES IN THE DIRECTORIES AND STORE IT IN AN FILE.<br />
| 	| GIVE ERROR IF THERE IS SOME PROBLEM<br />
<br />
	get.filenames()<br />
	if err.hap = tcyesno.yes then<br />
		err.hap = tcyesno.no<br />
		seq.close(fp.log.tmp)<br />
		end()<br />
	endif<br />
| 	display.form.message(sprintf$(form.text$(&quot;tdwms26210.14&quot;),file.ctr))<br />
| 	|* Total Number Of Files : %d<br />
| 	| PROCEDURE 2 END<br />
<br />
| 	| PROCEDURE 3 STARTS <br />
| 		| PROCESS EACH FILE ATE AT A TIME,  IN A LOOP 		| POLCUS10.eo<br />
	<br />
	for i = 1 to file.ctr<br />
	|	db.retry.point()		|san	|LK.O<br />
		display.form.message(sprintf$(form.text$(&quot;tdwms26210.15&quot;),i,file.ctr))<br />
		|* Processing File No: %d of %d Files<br />
		initailize.variables.level2()<br />
		file.name = strip$(file_arr(1,i))<br />
<br />
		| PROCEDURE 3.1 STARTS Validate File Name<br />
| 		validate.filename()			| POLCUS10.o<br />
| 		copy_files()	|#POLCUS02.n	<br />
| 		if err.hap = tcyesno.yes then<br />
| 			err.hap = tcyesno.no<br />
| 		|	copy_files()	|#POLCUS02.o	<br />
| 			dele_files()	|#POLCUS02.n			<br />
| 			continue<br />
| 		endif<br />
		| PROCEDURE 3.1 END<br />
	<br />
		| PROCEDURE 3.2 STARTS Read ASN file<br />
		asn.read.file()<br />
		copy_files()		| POLCUS01.n	<br />
		if err.hap = tcyesno.yes then<br />
			err.hap = tcyesno.no<br />
			seq.close(fp)<br />
		|	copy_files()	|#POLCUS02.o	<br />
			dele_files()	|#POLCUS02.n	<br />
			continue<br />
		endif<br />
		| PROCEDURE 3.2 END<br />
	<br />
		| PROCEDURE 3.3 STARTS<br />
		m.suno = &quot;&quot;								| POLCUS10.n<br />
		for j = 1 to rec.ctr <br />
| 			db.retry.point()	|san<br />
			initailize.variables.level3()<br />
			current.record = str_arr(1,j)<br />
			file.ship.id = current.record(35;15)<br />
			asn.no = strip$(shiftl$(file.ship.id))<br />
			<br />
			file.rec.type = current.record(55;1)<br />
			if j = 1 then<br />
				file.seq.no = current.record(258;15)<br />
				seq.no = val(file.seq.no)<br />
				file.supplier = current.record(13;12)			| POLCUS10.n<br />
				supplier = strip$(shiftl$(file.supplier))		| POLCUS10.n	<br />
				tt.align.according.domain(supplier, supplier, &quot;tcsuno&quot;) | POLCUS10.n<br />
			endif<br />
<br />
			rec.type = val(file.rec.type)<br />
			<br />
			on case rec.type<br />
			case 0:<br />
				get.variables.rec.0()		|(Rec type 0 Variables)<br />
				break<br />
			case 1:	<br />
				get.variables.rec.1()		|(Rec type 1 Variables)<br />
				break<br />
			case 2:<br />
				file.plant.code = current.record(10;3)<br />
				file.supplier = current.record(13;12)			<br />
				file.ship.id = current.record(35;15)<br />
				<br />
				plant.code = strip$(shiftl$(file.plant.code))<br />
| 				supplier = strip$(shiftl$(file.supplier))		| POLCUS10.o<br />
| 				tt.align.according.domain(supplier, supplier, &quot;tcsuno&quot;) | POLCUS10.o<br />
				asn.no = strip$(shiftl$(file.ship.id))<br />
				m.suno = strip$(shiftl$(file.supplier))			| POLCUS10.n<br />
				tt.align.according.domain(m.suno, m.suno, &quot;tcsuno&quot;) | POLCUS10.n<br />
				if m.suno &lt;&gt; supplier then<br />
					break<br />
				endif	<br />
				assign.file.variables()<br />
				populate.table.fields()<br />
				break<br />
			default:<br />
				break<br />
			endcase	<br />
			if error.found then		<br />
				break			<br />
			endif<br />
			<br />
		endfor<br />
		| PROCEDURE 3.3 END<br />
		commit.transaction()<br />
	|	copy_files()	|#POLCUS02.o	<br />
		dele_files()	|#POLCUS02.n	<br />
|		tdwmsdll0017.sendmail(asn.no,asn.no)		| san to finalised<br />
	endfor	<br />
	seq.close(fp.log.tmp)<br />
	| PROCEDURE 3 END <br />
<br />
	commit.transaction()<br />
}<br />
<br />
function initailize.variables.level1()<br />
{<br />
	ret = set.mem(file_arr,&quot;&quot;)<br />
	ret = set.mem(str_arr,&quot;&quot;)<br />
	file.blank = tcyesno.yes<br />
	file.ctr = 0<br />
}<br />
<br />
<br />
function initial_actions()<br />
{<br />
	<br />
	home.company = get.compnr()<br />
	select tdwms600.*<br />
	from tdwms600<br />
	where tdwms600._index1 = {:home.company}<br />
	selectdo<br />
		path.move.o  = tdwms600.mpth<br />
		path.input.o = tdwms600.path<br />
		path.proc.o  = tdwms600.hpth<br />
		path.log.o   = tdwms600.lpth<br />
	endselect<br />
	<br />
	<br />
	str_date = dte$()<br />
	path.log.tmp = concat$(&quot;/&quot;,strip$(path.log.o),&quot;log&quot;)<br />
	path.log.tmp = path.log.tmp &amp;&quot;_&quot;&amp; str_date(5;2) &amp; str_date(1;2) &amp; str_date(3;2) &amp; str_date(7;6) <br />
	fp.log.tmp = seq.open(path.log.tmp,&quot;w&quot;)<br />
	<br />
	if fp.log.tmp &lt; 1 then<br />
		mess(&quot;tdwms26210.02&quot;,1) <br />
		|* Unable to Open the base CSCN ASN log file!<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif<br />
}<br />
<br />
function get.filenames()<br />
{<br />
<br />
	ls.path.name = &quot;ls &quot; &amp; strip$(path.input.o) &amp;&quot; &gt; &quot; &amp; strip$(path.log.o) &amp; &quot;/CSCN_ASN_files&quot;<br />
	ret = shell(ls.path.name, 0)<br />
		<br />
	fp.tmp = seq.open(concat$(&quot;/&quot;,strip$(path.log.o),&quot;CSCN_ASN_files&quot;),&quot;r&quot;)<br />
		<br />
	if fp.tmp &lt; 1 then<br />
		|ERROR MESSAGE IS :	Unable to Open the base log file!<br />
		seq.puts(form.text$(&quot;tdwms26210.02&quot;),fp.log.tmp)<br />
		|* Unable to Open the base CSCN ASN log file!<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif<br />
	<br />
	while (seq.eof(fp.tmp) = 0) <br />
		file.val = seq.gets(file.line,RECORDLN, fp.tmp)<br />
		|* To check if any file is available to upload<br />
		<br />
		if (file.val &lt; 0 and file.blank = tcyesno.yes) then<br />
			|ERROR MESSAGE IS :No File Available To Upload !<br />
			seq.puts(form.text$(&quot;tdwms26210.03&quot;),fp.log.tmp)<br />
			|* No File Available To Upload !<br />
			err.hap = tcyesno.yes<br />
			return<br />
		else<br />
			if file.val = 0 then<br />
				file.blank = tcyesno.no<br />
				file.ctr = file.ctr + 1	<br />
				file_arr(1,file.ctr) = file.line<br />
			endif<br />
		endif<br />
	<br />
	endwhile<br />
		<br />
	if file.ctr = 0 then<br />
		|ERROR MESSAGE IS :No Files to Upload!	<br />
		seq.puts(form.text$(&quot;tdwms26210.03&quot;),fp.log.tmp)<br />
		|* No File Available To Upload !<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif<br />
		<br />
	seq.close(fp.tmp)<br />
}<br />
<br />
<br />
function get.filenames.new()<br />
{<br />
<br />
	ls.path.name = &quot;ls &quot; &amp; strip$(path.move.o) &amp;&quot; &gt; &quot; &amp; strip$(path.log.o) &amp; &quot;/VALID_ASN_files&quot;<br />
	ret = shell(ls.path.name, 0)<br />
		<br />
	fp.tmp = seq.open(concat$(&quot;/&quot;,strip$(path.log.o),&quot;VALID_ASN_files&quot;),&quot;r&quot;)<br />
		<br />
	if fp.tmp &lt; 1 then<br />
		|ERROR MESSAGE IS :	Unable to Open the base log file!<br />
		seq.puts(form.text$(&quot;tdwms26210.27&quot;),fp.log.tmp)<br />
		|* tdwms26210.27  ????????????????????????????????????????<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif<br />
	<br />
	while (seq.eof(fp.tmp) = 0) <br />
		file.val = seq.gets(file.line,RECORDLN, fp.tmp)<br />
		|* To check if any file is available to upload<br />
		<br />
		if (file.val &lt; 0 and file.blank = tcyesno.yes) then<br />
			|ERROR MESSAGE IS :No File Available To Upload !<br />
			seq.puts(form.text$(&quot;tdwms26210.03&quot;),fp.log.tmp)<br />
			|* No File Available To Upload !<br />
			err.hap = tcyesno.yes<br />
			return<br />
		else<br />
			if file.val = 0 then<br />
				file.blank = tcyesno.no<br />
				file.ctr = file.ctr + 1	<br />
				file_arr(1,file.ctr) = file.line<br />
				<br />
				file.name = strip$(file_arr(1,file.ctr))<br />
				validate.filename.new()<br />
<br />
				if err.hap = tcyesno.yes then<br />
					err.hap = tcyesno.no<br />
					dele_source_files()	<br />
					continue<br />
				endif<br />
				asn.read.file.new()   <br />
				if err.hap = tcyesno.yes then<br />
					err.hap = tcyesno.no<br />
					seq.close(fp)<br />
					dele_source_files()	<br />
					continue<br />
				else<br />
					move_source_files()<br />
				endif				<br />
				<br />
			endif<br />
		endif<br />
	<br />
	endwhile<br />
		<br />
	if file.ctr = 0 then						<br />
		|ERROR MESSAGE IS :No Files to Upload!	<br />
		seq.puts(form.text$(&quot;tdwms26210.03&quot;),fp.log.tmp)<br />
		|* No File Available To Upload !<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif								<br />
		<br />
	seq.close(fp.tmp)<br />
}<br />
<br />
<br />
function initailize.variables.level2()<br />
{<br />
	ret 		= set.mem(str_arr,&quot;&quot;)<br />
	rec.ctr 	= 0<br />
	plant.code	= &quot;&quot;<br />
	supplier	= &quot;&quot;<br />
	asn.no		= &quot;&quot;<br />
	trans.date	= 0<br />
	seq.no		= 0<br />
	packing.list.no	= &quot;&quot;<br />
	bill.lading.no 	= &quot;&quot;<br />
	carrier.ref.no 	= &quot;&quot;<br />
	freight.bill.no	= &quot;&quot;<br />
	ship.date	= 0<br />
	ship.time	= 0<br />
	arrival.date	= 0<br />
	arrival.time	= 0<br />
	no.container	= 0<br />
	wght.shipment	= 0<br />
	wght.uom	= &quot;&quot;<br />
	purpose.code	= empty<br />
	ship.to.name	= &quot;&quot;<br />
	ship.to.code	= &quot;&quot;<br />
	scac.code       = &quot;&quot;<br />
}<br />
<br />
function asn.read.file.new()<br />
{<br />
	|OPEN THE MAIN FILE<br />
	path.input = strip$(concat$(&quot;/&quot;,strip$(path.input.o),file.name))<br />
	fp = seq.open(path.move,&quot;r&quot;)<br />
	rec.ctr = 0<br />
	<br />
	if fp &lt; 1 then<br />
		|ERROR MESSGE : Unable to open the input file! File Skipped!<br />
		seq.puts(sprintf$(form.text$(&quot;tdwms26210.05&quot;),file.name),fp.log.tmp)<br />
		|* Unable to open the input file %s! File Skipped!<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif<br />
<br />
	while (seq.eof(fp) = 0) <br />
		retval = seq.gets(retline,RECORDLN, fp)<br />
<br />
		if (retval &lt; 0 and file.blank = tcyesno.yes) then<br />
			|ERROR MESSAGE IS :Given file is blank!<br />
			seq.puts(sprintf$(form.text$(&quot;tdwms26210.06&quot;),file.name),fp.log.tmp)<br />
			|* Given file %s is blank!<br />
			err.hap = tcyesno.yes<br />
			return<br />
		else<br />
			if retval = 0 then<br />
				file.blank = tcyesno.no<br />
				rec.ctr = rec.ctr + 1	<br />
				if rec.ctr  = 1 then<br />
					if not valid.asn.file.new() then<br />
						err.hap = tcyesno.yes<br />
						return<br />
					else<br />
						seq.close(fp)<br />
						return<br />
					endif	<br />
				endif	<br />
| 				str_arr(1,rec.ctr) = retline<br />
			endif<br />
		endif<br />
	endwhile<br />
	seq.close(fp)<br />
}<br />
<br />
function domain tcbool valid.asn.file.new()			| POLCUS10.sn<br />
{<br />
	file.rec.type = retline(55;1)<br />
	rec.type = val(file.rec.type)<br />
	<br />
	if rec.type = 0 then<br />
		file.plant.code = retline(10;3)<br />
		file.supplier = retline(13;12)<br />
		file.ship.id = retline(35;15)<br />
		<br />
		asn.no = strip$(shiftl$(file.ship.id))<br />
		plant.code = strip$(shiftl$(file.plant.code))<br />
		supplier = strip$(shiftl$(file.supplier))<br />
	<br />
		file.trans.date = retline(25;6)<br />
		file.trans.time = retline(31;4)<br />
		file.seq.no = retline(258;15)<br />
		file.purpose.code = retline(255;2)<br />
		<br />
		dd = lval(file.trans.date(5;2))					<br />
		mm = lval(file.trans.date(3;2))<br />
		yy = 2000 + lval(file.trans.date(1;2))					<br />
		trans.date = date.to.num(yy,mm,dd)				<br />
		<br />
		x.error.code = &quot;&quot;<br />
		file.load = false<br />
		If isspace(asn.no)then<br />
			seq.puts(sprintf$(form.text$(&quot;tdwms26210.23&quot;),file.name),fp.log.tmp)<br />
			|* ASN number is blank, Not valid file %s<br />
			return(false)<br />
		endif<br />
<br />
		if isspace(supplier) then<br />
			x.error.code = form.text$(&quot;tdwms26210.08&quot;)<br />
			|* Supplier Doesn't exists in BAAN ! File Skipped !<br />
			write.log.table() <br />
			return(false)<br />
		endif		<br />
<br />
		if plant.code &lt;&gt; strip$(tdwms600.plnt) then <br />
			x.error.code = form.text$(&quot;tdwms26210.07&quot;)<br />
			|* Plant Code Different from Parameter defination! File Skipped!<br />
			write.log.table() <br />
			return(false)<br />
		endif	<br />
		<br />
		if trans.date &lt;= 0 then						<br />
			x.error.code = form.text$(&quot;tdwms26210.24&quot;)<br />
			|* Transaction Date is Blank in File. File Skipped<br />
			write.log.table() <br />
			return(false)<br />
		endif							<br />
		trans.time = lval(file.trans.time) * 100<br />
		seq.no = val(file.seq.no)<br />
	<br />
		find.seq()<br />
		if seq.no = m.seqn then<br />
			x.error.code = sprintf$(form.text$(&quot;tdwms26210.22&quot;),m.seqn)<br />
			|* File is already loaded for Seqn : %s<br />
		endif<br />
		if seq.no &lt; m.seqn then<br />
			x.error.code = sprintf$(form.text$(&quot;tdwms26210.13&quot;),m.seqn)<br />
			|* Higher Seqn : %s is already Loaded<br />
		endif<br />
		if not isspace(x.error.code) then<br />
			write.log.table()<br />
			return(false)<br />
		else<br />
			return(true)<br />
		endif<br />
	endif	<br />
	return(true)<br />
}								| POLCUS10.en<br />
<br />
function asn.read.file()<br />
{<br />
	|OPEN THE MAIN FILE<br />
	path.input = strip$(concat$(&quot;/&quot;,strip$(path.input.o),file.name))<br />
	fp = seq.open(path.input,&quot;r&quot;)<br />
	<br />
	if fp &lt; 1 then<br />
		|ERROR MESSGE : Unable to open the input file! File Skipped!<br />
		seq.puts(sprintf$(form.text$(&quot;tdwms26210.05&quot;),file.name),fp.log.tmp)<br />
		|* Unable to open the input file %s! File Skipped!<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif<br />
<br />
	while (seq.eof(fp) = 0) <br />
		retval = seq.gets(retline,RECORDLN, fp)<br />
<br />
		if (retval &lt; 0 and file.blank = tcyesno.yes) then<br />
			|ERROR MESSAGE IS :Given file is blank!<br />
			seq.puts(sprintf$(form.text$(&quot;tdwms26210.06&quot;),file.name),fp.log.tmp)<br />
			|* Given file %s is blank!<br />
			err.hap = tcyesno.yes<br />
			return<br />
		else<br />
			if retval = 0 then<br />
				file.blank = tcyesno.no<br />
				rec.ctr = rec.ctr + 1	<br />
				if rec.ctr  = 1 then<br />
					if not valid.asn.file() then<br />
						err.hap = tcyesno.yes<br />
						return<br />
					endif	<br />
				endif	<br />
				str_arr(1,rec.ctr) = retline<br />
			endif<br />
		endif<br />
	endwhile<br />
	seq.close(fp)<br />
}<br />
<br />
function domain tcbool valid.asn.file()<br />
{<br />
	file.rec.type = retline(55;1)<br />
	rec.type = val(file.rec.type)<br />
	<br />
	if rec.type = 0 then<br />
		file.plant.code = retline(10;3)<br />
		file.supplier = retline(13;12)<br />
		file.ship.id = retline(35;15)<br />
		<br />
		asn.no = strip$(shiftl$(file.ship.id))<br />
		plant.code = strip$(shiftl$(file.plant.code))<br />
		supplier = strip$(shiftl$(file.supplier))<br />
	<br />
		file.trans.date = retline(25;6)<br />
		file.trans.time = retline(31;4)<br />
		file.seq.no = retline(258;15)<br />
		file.purpose.code = retline(255;2)<br />
		<br />
		dd = lval(file.trans.date(5;2))					<br />
		mm = lval(file.trans.date(3;2))<br />
		yy = 2000 + lval(file.trans.date(1;2))					<br />
		trans.date = date.to.num(yy,mm,dd)				<br />
		<br />
		x.error.code = &quot;&quot;<br />
		file.load = false<br />
		If isspace(asn.no)then<br />
			seq.puts(sprintf$(form.text$(&quot;tdwms26210.23&quot;),file.name),fp.log.tmp)<br />
			|* ASN number is blank, Not valid file %s<br />
			return(false)<br />
		endif<br />
			<br />
		if plant.code &lt;&gt; strip$(tdwms600.plnt) then <br />
			x.error.code = form.text$(&quot;tdwms26210.07&quot;)<br />
			|* Plant Code Different from Parameter defination! File Skipped!<br />
			write.log.table() <br />
			return(false)<br />
		endif	<br />
		<br />
		if trans.date &lt;= 0 then						<br />
			x.error.code = form.text$(&quot;tdwms26210.24&quot;)<br />
			|* Transaction Date is Blank in File. File Skipped<br />
			write.log.table() <br />
			return(false)<br />
		endif							<br />
		trans.time = lval(file.trans.time) * 100<br />
		seq.no = val(file.seq.no)<br />
	<br />
		find.seq()<br />
		if seq.no = m.seqn then<br />
			x.error.code = sprintf$(form.text$(&quot;tdwms26210.22&quot;),m.seqn)<br />
			|* File is already loaded for Seqn : %s<br />
		endif<br />
		if seq.no &lt; m.seqn then<br />
			x.error.code = sprintf$(form.text$(&quot;tdwms26210.13&quot;),m.seqn)<br />
			|* Higher Seqn : %s is already Loaded<br />
		endif<br />
		if seq.no &gt; m.seqn then<br />
			if m.seqn = 0 then<br />
				file.load = true<br />
			else	<br />
				if rec.processed() then<br />
					x.error.code = sprintf$(form.text$(&quot;tdwms26210.11&quot;),m.seqn)<br />
					|* Seq.%s Already Processed... Cannot Replace<br />
				else	<br />
					if file.purpose.code = &quot;00&quot; or  file.purpose.code = &quot;05&quot; then<br />
						cancel.asnn.data()<br />
						if m.seqn &lt;&gt; 0 then<br />
							x.error.code = sprintf$(form.text$(&quot;tdwms26210.20&quot;),m.seqn)<br />
							|* Seq.%s moved to Archieve Table - For Add / Replacement<br />
						endif						<br />
						file.load = true<br />
					endif<br />
<br />
					if file.purpose.code = &quot;01&quot; then<br />
 						cancel.asnn.data()	<br />
						if m.seqn &lt;&gt; 0 then<br />
							x.error.code = sprintf$(form.text$(&quot;tdwms26210.19&quot;),m.seqn)<br />
							|* Seq.%s moved to Archieve Table - For Deletation<br />
						endif<br />
 					endif<br />
<br />
				endif<br />
			endif<br />
		endif<br />
		if not isspace(x.error.code) then<br />
			write.log.table()    <br />
		endif<br />
		if file.load then<br />
			return(true)<br />
		else<br />
			return(false)<br />
		endif<br />
	endif	<br />
	return(true)<br />
}<br />
<br />
function copy_files()<br />
{<br />
	long ret, ret1<br />
	string	dat(12)<br />
	long file.size,c.time,m.time,a.time	|#POLCUS01.n<br />
	dat = dte$()<br />
	bckp.path = strip$(concat$(&quot;/&quot;,strip$(path.proc.o),&quot;bkp&quot;))<br />
	bckp.path = strip$(concat$(&quot;/&quot;,strip$(bckp.path),file.name))<br />
	<br />
	path.proc = strip$(concat$(&quot;/&quot;,strip$(path.proc.o),file.name)) &amp;&quot;_&quot;&amp; dat(5;2) &amp; dat(1;2) &amp; dat(3;2) &amp; dat(7;6) <br />
	<br />
	cv.path.name = &quot;cp &quot; &amp; path.input &amp;&quot; &quot; &amp; bckp.path<br />
|	mv.path.name = &quot;mv &quot; &amp; path.input &amp;&quot; &quot; &amp; path.proc	|lk.o<br />
	mv.path.name = &quot;cp &quot; &amp; path.input &amp;&quot; &quot; &amp; path.proc	|lk.n<br />
	if file.stat(bckp.path,file.size,c.time,m.time,a.time) &lt;&gt; 0 then	|#POLCUS01.n	<br />
		<br />
	|	ret = shell(cv.path.name, 0)	|lk.o	|#POLCUS01.o<br />
		ret = shell(cv.path.name, 0)	|lk.o	|#POLCUS01.n<br />
	|	suspend(90) |lktest<br />
	|	ret = shell(mv.path.name, 0)	|lk.o	|#POLCUS01.o<br />
		ret = shell(mv.path.name, 0)	|lk.o	|#POLCUS01.n	<br />
	|	suspend(90) |lktest<br />
	endif					|#POLCUS01.n<br />
| 	mv.path.name = &quot;rm &quot; &amp; path.input 	|lk.n	|#POLCUS02.so<br />
| |	ret = shell(mv.path.name, 0)	|lk.n	|#POLCUS01.o<br />
| 	ret = shell(mv.path.name, 1)	|lk.n	|#POLCUS01.n<br />
| 	suspend(80) |lktest<br />
| | 	ret = shell(cv.path.name, 1)	|lk.n<br />
| | 	ret = shell(mv.path.name, 1)	|lk.n<br />
|							|#POLCUS02.eo<br />
}<br />
<br />
function dele_files()		|#POLCUS02.sn<br />
{<br />
	mv.path.name = &quot;rm &quot; &amp; path.input<br />
	ret = shell(mv.path.name, 0)<br />
|	suspend(70) |lktest	<br />
	<br />
}				|#POLCUS02.en<br />
function write.log.table()<br />
{<br />
	m.srno = 0<br />
	select tdwms609.*<br />
	from   tdwms609 <br />
	where  tdwms609._index1 = {:asn.no,:seq.no}<br />
	order by tdwms609._index1 desc<br />
	as set with 1 rows<br />
	selectdo<br />
		m.srno = tdwms609.srno<br />
	endselect<br />
	m.srno = m.srno + 1<br />
	<br />
	select tdwms609.*<br />
	from   tdwms609 <br />
	where  tdwms609._index1 = {:asn.no,:seq.no,:m.srno}<br />
	selectdo<br />
	selectempty<br />
		tdwms609.asnn = asn.no<br />
		tdwms609.seqn = seq.no<br />
		tdwms609.srno = m.srno<br />
		tdwms609.rema = x.error.code<br />
		tdwms609.date = curr.date<br />
		tdwms609.time = curr.time<br />
		db.insert(ttdwms609,db.retry)<br />
		commit.transaction()<br />
	endselect<br />
}<br />
<br />
function initailize.variables.level3()<br />
{<br />
	item		= &quot;&quot;<br />
	vendor.item	= &quot;&quot;<br />
	revision	= &quot;&quot;<br />
	pack.list.2	= &quot;&quot;<br />
	unit.ship	= 0	<br />
	uom		= &quot;&quot;<br />
}<br />
<br />
function get.variables.rec.0()		|(Rec type 0 Variables)<br />
{<br />
	file.ship.id = current.record(35;15)<br />
	<br />
	file.pack.list.0 = current.record(91;15)<br />
	file.bill.lading.no = current.record(106;15)<br />
	file.carrier.ref.no = current.record(121;15) <br />
	file.freight.bill.no = current.record(136;30)<br />
	<br />
	file.ship.date = current.record(168;6)<br />
	file.ship.time = current.record(174;4)<br />
	<br />
	file.arrival.date = current.record(180;6)<br />
	file.arrival.time = current.record(186;4)<br />
	file.no.container = current.record(190;7)<br />
	file.wght.shipment = current.record(198;11)<br />
	file.wght.uom = current.record(210;2)<br />
	file.scac.code = current.record(214;17)<br />
	file.purpose.code = current.record(255;2)<br />
	<br />
	asn.no = strip$(shiftl$(file.ship.id))<br />
	<br />
	packing.list.no = file.pack.list.0<br />
	bill.lading.no = file.bill.lading.no<br />
	carrier.ref.no = file.carrier.ref.no<br />
	freight.bill.no = file.freight.bill.no<br />
	<br />
	dd = lval(file.ship.date(5;2))					<br />
	mm = lval(file.ship.date(3;2))<br />
	yy = 2000 + lval(file.ship.date(1;2))					<br />
	ship.date = date.to.num(yy,mm,dd)				<br />
	if ship.date &lt; 0 then						<br />
		ship.date = 0<br />
	endif				<br />
	<br />
	ship.time = lval(file.ship.time) * 100<br />
	scac.code = strip$(shiftl$(file.scac.code))<br />
	<br />
	dd = lval(file.arrival.date(5;2))					<br />
	mm = lval(file.arrival.date(3;2))<br />
	yy = 2000 + lval(file.arrival.date(1;2))					<br />
	arrival.date = date.to.num(yy,mm,dd)				<br />
	if arrival.date &lt; 0 then						<br />
		arrival.date = 0<br />
	endif					<br />
	<br />
	arrival.time = lval(file.arrival.time) * 100<br />
	no.container = lval(file.no.container)<br />
	<br />
	wght.shipment = val(file.wght.shipment)<br />
	if not isspace(file.wght.uom) then<br />
		get.unit.from.unit.master(file.wght.uom,wght.uom)<br />
	endif<br />
	<br />
	if not isspace(file.purpose.code) then<br />
		on case file.purpose.code<br />
		case &quot;00&quot;:<br />
			purpose.code = tdwms.purpose.new<br />
			break<br />
		case &quot;01&quot;:<br />
			purpose.code = tdwms.purpose.delete<br />
			break<br />
		case &quot;05&quot;:<br />
			purpose.code = tdwms.purpose.replacement<br />
			break<br />
		endcase<br />
	endif<br />
	<br />
}<br />
<br />
function get.unit.from.unit.master(	domain tcmcs.str2 i.cuni,<br />
				   ref	domain tccuni     o.cuni)<br />
{<br />
	o.cuni =  &quot;&quot;<br />
	select	tdwms605.cuni:o.cuni<br />
	from	tdwms605<br />
	where	tdwms605._index1 = {:i.cuni}<br />
	selectdo<br />
	endselect	<br />
}<br />
<br />
function get.variables.rec.1()		|(Rec type 1 Variables)<br />
{<br />
	file.ship.to.code = current.record(91;10)<br />
	ship.to.code = file.ship.to.code<br />
}<br />
<br />
<br />
function assign.file.variables()<br />
{<br />
	error.code = &quot;&quot;<br />
	file.item = current.record(84;30)<br />
	file.vendor.item = current.record(114;30)<br />
	file.revision = current.record(144;2)<br />
	file.pack.list.2 = current.record(146;15)<br />
	file.unit.ship = current.record(161;11)<br />
	file.uom = current.record(173;4)<br />
	<br />
	item = strip$(shiftl$(file.item))<br />
	tt.align.according.domain(item, item, &quot;tcitem&quot;)<br />
	vendor.item = strip$(shiftl$(file.vendor.item))<br />
	revision = strip$(shiftl$(file.revision))<br />
	pack.list.2 = strip$(shiftl$(file.pack.list.2))<br />
	unit.ship = val(file.unit.ship)<br />
	if not isspace(file.uom) then<br />
		get.unit.from.unit.master(file.uom,uom)<br />
	endif<br />
}<br />
<br />
function populate.table.fields()<br />
{<br />
	if purpose.code &lt;&gt; tdwms.purpose.delete then<br />
		fill.header()<br />
		if error.found then	<br />
			return		<br />
		endif			<br />
		fill.lines()<br />
	endif	<br />
}<br />
<br />
function fill.header()<br />
{<br />
	x.error.code = &quot;&quot;<br />
	table.name = &quot;&quot;<br />
	error.found = false<br />
<br />
| 	select	tdwms610.asnn					| POLCUS10.o<br />
	select	tdwms610.asnn,tdwms610.suno,tdwms610.seqn	| POLCUS10.n<br />
	from	tdwms610<br />
	where	tdwms610._index1 = {:asn.no, :supplier, :seq.no}<br />
	selectdo<br />
	selectempty<br />
		|tdwms610 fields<br />
		tdwms610.asnn = asn.no<br />
		tdwms610.suno = supplier<br />
		tdwms610.seqn = seq.no<br />
		tdwms610.tsdt = trans.date<br />
		tdwms610.tstm = trans.time<br />
		tdwms610.stat = purpose.code<br />
		tdwms610.proc = tcyesno.no<br />
		tdwms610.updt = curr.date		<br />
		tdwms610.uptm = curr.time		<br />
		<br />
		table.name = &quot;tdwms610&quot;				<br />
		table.eror = db.insert(ttdwms610,db.retry,db.return.error)<br />
		if table.eror &lt;&gt; 0 then<br />
			abort.transaction()<br />
			x.error.code = form.text$(&quot;tdwms26210.26&quot;)<br />
			|* Error : %s on Table %s<br />
			x.error.code = sprintf$(x.error.code,table.eror,table.name)<br />
 			write.log.table()<br />
			error.found = true<br />
			return<br />
		endif						<br />
		<br />
		|tdwms611 fields<br />
		tdwms611.asnn = asn.no<br />
		tdwms611.suno = supplier<br />
		tdwms611.seqn = seq.no<br />
		tdwms611.pack = packing.list.no<br />
		tdwms611.bill = bill.lading.no <br />
		tdwms611.crer = carrier.ref.no <br />
		tdwms611.frgh = freight.bill.no<br />
		tdwms611.shdt = ship.date<br />
		tdwms611.shtm = ship.time<br />
		tdwms611.ardt = arrival.date<br />
		tdwms611.artm = arrival.time<br />
		tdwms611.cont = no.container<br />
		tdwms611.wght = wght.shipment<br />
		tdwms611.unit = wght.uom<br />
		tdwms611.shto = ship.to.code<br />
		tdwms611.scac = scac.code<br />
		<br />
		table.name = &quot;tdwms611&quot;				<br />
		table.eror = db.insert(ttdwms611,db.retry,db.return.error)<br />
		if table.eror &lt;&gt; 0 then<br />
			abort.transaction()<br />
			x.error.code = form.text$(&quot;tdwms26210.26&quot;)<br />
			|* Error : %s on Table %s<br />
			x.error.code = sprintf$(x.error.code,str$(db.error.message()),table.name)<br />
 			write.log.table()<br />
			error.found = true<br />
			return<br />
		endif						<br />
		commit.transaction()<br />
		<br />
		temp.date = arrival.date<br />
		if temp.date = 0 then<br />
			temp.date = curr.date<br />
		endif<br />
		<br />
	endselect	<br />
	<br />
}<br />
<br />
function fill.lines()<br />
{<br />
	select	tdwms615.item<br />
	from	tdwms615<br />
	where	tdwms615._index1 = {:tdwms610.asnn,:tdwms610.suno,:tdwms610.seqn,:pack.list.2,:item}<br />
	selectdo<br />
	selectempty<br />
		tdwms615.asnn = tdwms610.asnn<br />
		tdwms615.suno = tdwms610.suno<br />
		tdwms615.seqn = tdwms610.seqn<br />
		tdwms615.item = item<br />
		tdwms615.cpno = vendor.item<br />
		tdwms615.plno = pack.list.2<br />
		tdwms615.revi = revision<br />
		tdwms615.cuni = uom<br />
		tdwms615.quan = unit.ship<br />
		tdwms615.aqun = unit.ship<br />
		tdwms615.pkgs = 1<br />
		tdwms615.apkg = 1<br />
		tdwms615.proc = tcyesno.no<br />
		tdwms615.recp = tcyesno.no<br />
		tdwms615.prdt = 0			<br />
		tdwms615.prtm = 0			<br />
		tdwms615.vald =	tcyesno.no<br />
		tdwms615.fcun = file.uom<br />
		tdwms615.cont = 0<br />
		tdwms615.copo = 0<br />
		tdwms615.schn = 0<br />
		tdwms615.orno = 0<br />
		tdwms615.pono = 0<br />
		tdwms615.reno = 0<br />
		tdwms615.ecod = &quot;&quot;<br />
		tdwms615.eafs = &quot;&quot;<br />
		tdwms615.eror = &quot;&quot;<br />
		if validate.record(tdwms615.asnn,		|Function From DLL tdwmsdll0016<br />
				   tdwms615.item,<br />
				   tdwms615.suno,<br />
				   tdwms615.cuni,<br />
				   tdwms615.aqun,<br />
				   temp.date,<br />
				   false,			|FLAG<br />
				   tdwms615.ecod,<br />
				   tdwms615.eror,<br />
				   tdwms615.eafs,<br />
				   tdwms615.cont,<br />
				   tdwms615.copo,<br />
				   tdwms615.schn,<br />
				   tdwms615.plno) then		<br />
			<br />
			tdwms615.vald =	tcyesno.yes<br />
		endif	<br />
		tdwms615.aqun = unit.ship<br />
<br />
		table.name = &quot;tdwms615&quot;				<br />
		table.eror = db.insert(ttdwms615,db.retry,db.return.error)<br />
		if table.eror &lt;&gt; 0 then<br />
			abort.transaction()<br />
			x.error.code = form.text$(&quot;tdwms26210.25&quot;)<br />
			|* Error : %s on Table %s for Item %s<br />
			x.error.code = sprintf$(x.error.code,str$(db.error.message()),table.name,item)<br />
 			write.log.table()<br />
			error.found = true<br />
			return<br />
		endif							<br />
<br />
	endselect<br />
| 	commit.transaction()<br />
	<br />
}<br />
<br />
function long rec.processed()<br />
{<br />
	m.seqn = 0<br />
	select	tdwms615.proc,tdwms615.seqn:m.seqn<br />
	from	tdwms615<br />
	where	tdwms615._index1 = {:asn.no}<br />
	and 	tdwms615.proc = tcyesno.yes	<br />
	as set with 1 rows<br />
	selectdo<br />
		return(true)<br />
	selectempty<br />
		select	tdwms650.seqn:m.seqn,tdwms650.asnn,tdwms650.suno<br />
		from	tdwms650<br />
		where	tdwms650._index1 = {:asn.no}<br />
		order by tdwms650._index1 desc<br />
		as set with 1 rows<br />
		selectdo<br />
			select	tdwms655.proc,tdwms655.seqn<br />
			from	tdwms655<br />
			where	tdwms655._index1 = {:tdwms650.asnn,:tdwms650.suno,:m.seqn}<br />
			and 	tdwms655.proc = tcyesno.yes	<br />
			as set with 1 rows<br />
			selectdo<br />
				return(true)<br />
			endselect<br />
		endselect<br />
	endselect	<br />
	return(false)<br />
}<br />
<br />
function long find.seq()<br />
{<br />
	m.seqn = 0<br />
	select	tdwms610.seqn:m.seqn<br />
	from	tdwms610<br />
	where	tdwms610._index1 = {:asn.no}<br />
	as set with 1 rows<br />
	selectdo<br />
		return(true)<br />
	selectempty<br />
		select	tdwms650.seqn:m.seqn,tdwms650.asnn,tdwms650.suno<br />
		from	tdwms650<br />
		where	tdwms650._index1 = {:asn.no}<br />
		order by tdwms650._index1 desc<br />
		as set with 1 rows<br />
		selectdo<br />
			return(true)<br />
		endselect<br />
	endselect	<br />
	return(false)<br />
}<br />
<br />
<br />
function cancel.asnn.data()<br />
{<br />
	select	tdwms610.* <br />
	from	tdwms610 for update<br />
	where   tdwms610._index1 = {:asn.no}<br />
	selectdo<br />
		rcd.ttdwms650 = rcd.ttdwms610<br />
		tdwms650.asns = tdwms.arcv.can<br />
		tdwms650._compnr = tdwms610._compnr<br />
		db.insert(ttdwms650,db.retry,db.skip.dupl)<br />
		select	tdwms611.*<br />
		from	tdwms611 for update<br />
		where	tdwms611._index1 = {:tdwms610.asnn,:tdwms610.suno,:tdwms610.seqn}<br />
		selectdo<br />
			rcd.ttdwms651 = rcd.ttdwms611<br />
			tdwms651._compnr = tdwms611._compnr<br />
			db.insert(ttdwms651,db.retry,db.skip.dupl)<br />
			db.delete(ttdwms611,db.retry)<br />
		endselect	<br />
		<br />
		select	tdwms615.*<br />
		from	tdwms615 for update<br />
		where	tdwms615._index1 = {:tdwms610.asnn,:tdwms610.suno,:tdwms610.seqn}<br />
		selectdo<br />
			rcd.ttdwms655 = rcd.ttdwms615<br />
			tdwms655._compnr = tdwms615._compnr<br />
			db.insert(ttdwms655,db.retry,db.skip.dupl)<br />
			<br />
			select	tdwms616.*<br />
			from	tdwms616 for update<br />
			where	tdwms616._index1 = {:tdwms615.asnn,:tdwms615.suno,:tdwms615.seqn,:tdwms615.plno,:tdwms615.item}<br />
			selectdo<br />
				rcd.ttdwms656 = rcd.ttdwms616<br />
				tdwms656._compnr = tdwms616._compnr<br />
				db.insert(ttdwms656,db.retry,db.skip.dupl)<br />
				db.delete(ttdwms616,db.retry)<br />
			endselect	<br />
| 			rcd.ttdwms655 = rcd.ttdwms615<br />
| 			tdwms655._compnr = tdwms615._compnr<br />
| 			db.insert(ttdwms655,db.retry,db.skip.dupl)<br />
			db.delete(ttdwms615,db.retry)<br />
		endselect	<br />
<br />
		db.delete(ttdwms610,db.retry,db.return.ref.exists)<br />
		commit.transaction()<br />
	selectempty<br />
		m.seqn = 0<br />
	endselect<br />
}<br />
<br />
function display.form.message(domain tcmcs.str60 mess.desc)<br />
{<br />
	string dat(12)<br />
	string ndat(15)<br />
	disp.messg = &quot;&quot;<br />
	dat = dte$()<br />
	ndat = dat(3;2) &amp; &quot;-&quot; &amp; dat(1;2) &amp; &quot;-&quot;  &amp;dat(5;2) &amp; &quot;:&quot; &amp; dat(7;2) &amp; &quot;:&quot; &amp; dat(9;2) &amp; &quot;:&quot; &amp; dat(11;2)<br />
	disp.messg = ndat &amp; &quot;-&quot; &amp; mess.desc<br />
	display(&quot;disp.messg&quot;)<br />
}<br />
<br />
function validate.filename()<br />
{<br />
	path.input = strip$(concat$(&quot;/&quot;,strip$(path.input.o),file.name))<br />
	if file.name(1;5) &lt;&gt; strip$(tdwms600.file) then<br />
		seq.puts(sprintf$(form.text$(&quot;tdwms26210.04&quot;),file.name),fp.log.tmp)<br />
		|* Invalid File Name %s! File Skipped!<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif	<br />
}<br />
<br />
function validate.filename.new()<br />
{<br />
	path.move = strip$(concat$(&quot;/&quot;,strip$(path.move.o),file.name))<br />
	if file.name(1;5) &lt;&gt; strip$(tdwms600.file) then<br />
		seq.puts(sprintf$(form.text$(&quot;tdwms26210.04&quot;),file.name),fp.log.tmp)<br />
		|* Invalid File Name %s! File Skipped!<br />
		err.hap = tcyesno.yes<br />
		return<br />
	endif	<br />
}<br />
<br />
<br />
function move_source_files()			| POLCUS10.sn<br />
{<br />
	long ret, ret1<br />
	string	dat(12)<br />
	long file.size,c.time,m.time,a.time	<br />
	dat = dte$()<br />
| 	bckp.path = strip$(concat$(&quot;/&quot;,strip$(path.proc.o),&quot;bkp&quot;))<br />
| 	bckp.path = strip$(concat$(&quot;/&quot;,strip$(bckp.path),file.name))<br />
	<br />
| 	path.proc = strip$(concat$(&quot;/&quot;,strip$(path.proc.o),file.name)) &amp;&quot;_&quot;&amp; dat(5;2) &amp; dat(1;2) &amp; dat(3;2) &amp; dat(7;6) <br />
	<br />
	mv.path.name = &quot;mv &quot; &amp; path.move &amp;&quot; &quot; &amp; path.input      <br />
<br />
	if file.stat(path.move,file.size,c.time,m.time,a.time) = 0 then	<br />
| 		ret = shell(cv.path.name, 0)	<br />
		ret = shell(mv.path.name, 0)	<br />
	endif					<br />
}						| POLCUS10.en<br />
<br />
function dele_source_files()		|#POLCUS10.sn<br />
{<br />
	mv.path.name = &quot;rm &quot; &amp; path.move <br />
	ret = shell(mv.path.name, 0)<br />
	<br />
}				|#POLCUS10.en<br />
<br />
<br />
Here is $BSE/lib/defaults/all<br />
<br />
<br />
session_timeout:30<br />
use_mbtextconv:1<br />
<br />
<br />
There is no file bse_vars in $BSE/lib<br />
<br />
Thanks in advance</div></div><hr />


<div class="post"><div class="posttop"><div class="username">NPRao</div><div class="date">4th June 2008, 10:47</div></div><div class="posttext">loveneesh,<br />
<br />
Few things I noticed is the use of shell() commands. You are hard-coding the OS commands into Baan code, instead of using the available tools functions. Refer to the Programmer's manual - Directory and file operations synopsis (http://www.baanboard.com/programmers_manual_baanerp_help_functions_directory_file_operations_synopsis) <br />
You can replace all the cp, mv, rm commands by file.cp(), file.mv() and file.rm() which are platform independent. <br />
<br />
    ls.path.name = &quot;ls &quot; &amp; strip$(path.input.o) &amp;&quot; &gt; &quot; &amp; strip$(path.log.o) &amp; &quot;/CSCN_ASN_files&quot;<br />
    ret = shell(ls.path.name, 0)<br />
Refer to the thread for the sample code to read the files in the directory - reading Ascii file (http://www.baanboard.com/baanboard/showthread.php?t=7414)<br />
The script does need some code clean up to use arrays, coding standards etc.<br />
<br />
if not valid.asn.file.new() then<br />
	err.hap = tcyesno.yes<br />
	return<br />
else<br />
	seq.close(fp)<br />
	return<br />
endif<br />
...<br />
        db.insert(ttdwms608,db.retry)<br />
        commit.transaction() <br />
<br />
The file pointer should be closed before the 1st return. The other statement will fail in case of duplicate records, missing db.skip.dupl option.</div></div><hr />


<div class="post"><div class="posttop"><div class="username">loveneesh</div><div class="date">5th June 2008, 10:22</div></div><div class="posttext">Thanks NPR,<br />
<br />
I will try and check the outcome</div></div><hr />



</div>
</body>
</html>